var languages639_1 = [
{'code':'ab','value':'Abkhaz'}, {'code':'aa','value':'Afar'}, {'code':'af','value':'Afrikaans'}, {'code':'ak','value':'Akan'}, {'code':'sq','value':'Albanian'},
{'code':'am','value':'Amharic'}, {'code':'ar','value':'Arabic'}, {'code':'an','value':'Aragonese'}, {'code':'hy','value':'Armenian'}, {'code':'as','value':'Assamese'},
{'code':'av','value':'Avaric'}, {'code':'ae','value':'Avestan'}, {'code':'ay','value':'Aymara'}, {'code':'az','value':'Azerbaijani'}, {'code':'bm','value':'Bambara'},
{'code':'ba','value':'Bashkir'}, {'code':'eu','value':'Basque'}, {'code':'be','value':'Belarusian'}, {'code':'bn','value':'Bengali, Bangla'}, {'code':'bh','value':'Bihari'},
{'code':'bi','value':'Bislama'}, {'code':'bs','value':'Bosnian'}, {'code':'br','value':'Breton'}, {'code':'bg','value':'Bulgarian'}, {'code':'my','value':'Burmese'},
{'code':'ca','value':'Catalan'}, {'code':'ch','value':'Chamorro'}, {'code':'ce','value':'Chechen'}, {'code':'ny','value':'Chichewa, Chewa, Nyanja'}, {'code':'zh','value':'Chinese'},
{'code':'cv','value':'Chuvash'}, {'code':'kw','value':'Cornish'}, {'code':'co','value':'Corsican'}, {'code':'cr','value':'Cree'}, {'code':'hr','value':'Croatian'},
{'code':'cs','value':'Czech'}, {'code':'da','value':'Danish'}, {'code':'dv','value':'Divehi, Dhivehi, Maldivian'}, {'code':'nl','value':'Dutch'}, {'code':'dz','value':'Dzongkha'},
{'code':'en','value':'English'}, {'code':'eo','value':'Esperanto'}, {'code':'et','value':'Estonian'}, {'code':'ee','value':'Ewe'}, {'code':'fo','value':'Faroese'},
{'code':'fj','value':'Fijian'}, {'code':'fi','value':'Finnish'}, {'code':'fr','value':'French'}, {'code':'ff','value':'Fula, Fulah, Pulaar, Pular'}, {'code':'gl','value':'Galician'},
{'code':'ka','value':'Georgian'}, {'code':'de','value':'German'}, {'code':'el','value':'Greek (modern)'}, {'code':'gn','value':'Guaraní'}, {'code':'gu','value':'Gujarati'},
{'code':'ht','value':'Haitian, Haitian Creole'}, {'code':'ha','value':'Hausa'}, {'code':'he','value':'Hebrew (modern)'}, {'code':'hz','value':'Herero'}, {'code':'hi','value':'Hindi'},
{'code':'ho','value':'Hiri Motu'}, {'code':'hu','value':'Hungarian'}, {'code':'ia','value':'Interlingua'}, {'code':'id','value':'Indonesian'}, {'code':'ie','value':'Interlingue'},
{'code':'ga','value':'Irish'}, {'code':'ig','value':'Igbo'}, {'code':'ik','value':'Inupiaq'}, {'code':'io','value':'Ido'}, {'code':'is','value':'Icelandic'},
{'code':'it','value':'Italian'}, {'code':'iu','value':'Inuktitut'}, {'code':'ja','value':'Japanese'}, {'code':'jv','value':'Javanese'}, {'code':'kl','value':'Kalaallisut, Greenlandic'},
{'code':'kn','value':'Kannada'}, {'code':'kr','value':'Kanuri'}, {'code':'ks','value':'Kashmiri'}, {'code':'kk','value':'Kazakh'}, {'code':'km','value':'Khmer'},
{'code':'ki','value':'Kikuyu, Gikuyu'}, {'code':'rw','value':'Kinyarwanda'}, {'code':'ky','value':'Kyrgyz'}, {'code':'kv','value':'Komi'}, {'code':'kg','value':'Kongo'},
{'code':'ko','value':'Korean'}, {'code':'ku','value':'Kurdish'}, {'code':'kj','value':'Kwanyama, Kuanyama'}, {'code':'la','value':'Latin'}, {'code':'lb','value':'Luxembourgish, Letzeburgesch'},
{'code':'lg','value':'Ganda'}, {'code':'li','value':'Limburgish, Limburgan, Limburger'}, {'code':'ln','value':'Lingala'}, {'code':'lo','value':'Lao'}, {'code':'lt','value':'Lithuanian'},
{'code':'lu','value':'Luba-Katanga'}, {'code':'lv','value':'Latvian'}, {'code':'gv','value':'Manx'}, {'code':'mk','value':'Macedonian'}, {'code':'mg','value':'Malagasy'},
{'code':'ms','value':'Malay'}, {'code':'ml','value':'Malayalam'}, {'code':'mt','value':'Maltese'}, {'code':'mi','value':'Māori'}, {'code':'mr','value':'Marathi (Marāṭhī)'},
{'code':'mh','value':'Marshallese'}, {'code':'mn','value':'Mongolian'}, {'code':'na','value':'Nauruan'}, {'code':'nv','value':'Navajo, Navaho'}, {'code':'nd','value':'Northern Ndebele'},
{'code':'ne','value':'Nepali'}, {'code':'ng','value':'Ndonga'}, {'code':'nb','value':'Norwegian Bokmål'}, {'code':'nn','value':'Norwegian Nynorsk'}, {'code':'no','value':'Norwegian'},
{'code':'ii','value':'Nuosu'}, {'code':'nr','value':'Southern Ndebele'}, {'code':'oc','value':'Occitan'}, {'code':'oj','value':'Ojibwe, Ojibwa'}, {'code':'cu','value':'Old Church Slavonic, Church Slavonic, Old Bulgarian'},
{'code':'om','value':'Oromo'}, {'code':'or','value':'Oriya'}, {'code':'os','value':'Ossetian, Ossetic'}, {'code':'pa','value':'Panjabi, Punjabi'}, {'code':'pi','value':'Pāli'},
{'code':'fa','value':'Persian (Farsi)'}, {'code':'pl','value':'Polish'}, {'code':'ps','value':'Pashto, Pushto'}, {'code':'pt','value':'Portuguese'}, {'code':'qu','value':'Quechua'},
{'code':'rm','value':'Romansh'}, {'code':'rn','value':'Kirundi'}, {'code':'rc','value':'Reunionese, Reunion Creole'}, {'code':'ro','value':'Romanian'}, {'code':'ru','value':'Russian'},
{'code':'sa','value':'Sanskrit (Saṁskṛta)'}, {'code':'sc','value':'Sardinian'}, {'code':'sd','value':'Sindhi'}, {'code':'se','value':'Northern Sami'}, {'code':'sm','value':'Samoan'},
{'code':'sg','value':'Sango'}, {'code':'sr','value':'Serbian'}, {'code':'gd','value':'Scottish Gaelic, Gaelic'}, {'code':'sn','value':'Shona'}, {'code':'si','value':'Sinhalese, Sinhala'},
{'code':'sk','value':'Slovak'}, {'code':'sl','value':'Slovene'}, {'code':'so','value':'Somali'}, {'code':'st','value':'Southern Sotho'}, {'code':'es','value':'Spanish'},
{'code':'su','value':'Sundanese'}, {'code':'sw','value':'Swahili'}, {'code':'ss','value':'Swati'}, {'code':'sv','value':'Swedish'}, {'code':'ta','value':'Tamil'},
{'code':'te','value':'Telugu'}, {'code':'tg','value':'Tajik'}, {'code':'th','value':'Thai'}, {'code':'ti','value':'Tigrinya'}, {'code':'bo','value':'Tibetan Standard, Tibetan, Central'},
{'code':'tk','value':'Turkmen'}, {'code':'tl','value':'Tagalog'}, {'code':'tn','value':'Tswana'}, {'code':'to','value':'Tonga (Tonga Islands)'}, {'code':'tr','value':'Turkish'},
{'code':'ts','value':'Tsonga'}, {'code':'tt','value':'Tatar'}, {'code':'tw','value':'Twi'}, {'code':'ty','value':'Tahitian'}, {'code':'ug','value':'Uyghur'},
{'code':'uk','value':'Ukrainian'}, {'code':'ur','value':'Urdu'}, {'code':'uz','value':'Uzbek'}, {'code':'ve','value':'Venda'}, {'code':'vi','value':'Vietnamese'},
{'code':'vo','value':'Volapük'}, {'code':'wa','value':'Walloon'}, {'code':'cy','value':'Welsh'}, {'code':'wo','value':'Wolof'}, {'code':'fy','value':'Western Frisian'},
{'code':'xh','value':'Xhosa'}, {'code':'yi','value':'Yiddish'}, {'code':'yo','value':'Yoruba'}, {'code':'za','value':'Zhuang, Chuang'}, {'code':'zu','value':'Zulu'}];
var languages639_2 = [
{'code':'abk','value':'Abkhaz'}, {'code':'aar','value':'Afar'}, {'code':'afr','value':'Afrikaans'}, {'code':'aka','value':'Akan'}, {'code':'sqi','value':'Albanian'},
{'code':'amh','value':'Amharic'}, {'code':'ara','value':'Arabic'}, {'code':'arg','value':'Aragonese'}, {'code':'hye','value':'Armenian'}, {'code':'asm','value':'Assamese'},
{'code':'ava','value':'Avaric'}, {'code':'ave','value':'Avestan'}, {'code':'aym','value':'Aymara'}, {'code':'aze','value':'Azerbaijani'}, {'code':'bam','value':'Bambara'},
{'code':'bak','value':'Bashkir'}, {'code':'eus','value':'Basque'}, {'code':'bel','value':'Belarusian'}, {'code':'ben','value':'Bengali, Bangla'}, {'code':'bih','value':'Bihari'},
{'code':'bis','value':'Bislama'}, {'code':'bos','value':'Bosnian'}, {'code':'bre','value':'Breton'}, {'code':'bul','value':'Bulgarian'}, {'code':'mya','value':'Burmese'},
{'code':'cat','value':'Catalan'}, {'code':'cha','value':'Chamorro'}, {'code':'che','value':'Chechen'}, {'code':'nya','value':'Chichewa, Chewa, Nyanja'}, {'code':'zho','value':'Chinese'},
{'code':'chv','value':'Chuvash'}, {'code':'cor','value':'Cornish'}, {'code':'cos','value':'Corsican'}, {'code':'cre','value':'Cree'}, {'code':'hrv','value':'Croatian'},
{'code':'ces','value':'Czech'}, {'code':'dan','value':'Danish'}, {'code':'div','value':'Divehi, Dhivehi, Maldivian'}, {'code':'nld','value':'Dutch'}, {'code':'dzo','value':'Dzongkha'},
{'code':'eng','value':'English'}, {'code':'epo','value':'Esperanto'}, {'code':'est','value':'Estonian'}, {'code':'ewe','value':'Ewe'}, {'code':'fao','value':'Faroese'},
{'code':'fij','value':'Fijian'}, {'code':'fin','value':'Finnish'}, {'code':'fra','value':'French'}, {'code':'ful','value':'Fula, Fulah, Pulaar, Pular'}, {'code':'glg','value':'Galician'},
{'code':'kat','value':'Georgian'}, {'code':'deu','value':'German'}, {'code':'ell','value':'Greek (modern)'}, {'code':'grn','value':'Guaraní'}, {'code':'guj','value':'Gujarati'},
{'code':'hat','value':'Haitian, Haitian Creole'}, {'code':'hau','value':'Hausa'}, {'code':'heb','value':'Hebrew (modern)'}, {'code':'her','value':'Herero'}, {'code':'hin','value':'Hindi'},
{'code':'hmo','value':'Hiri Motu'}, {'code':'hun','value':'Hungarian'}, {'code':'ina','value':'Interlingua'}, {'code':'ind','value':'Indonesian'}, {'code':'ile','value':'Interlingue'},
{'code':'gle','value':'Irish'}, {'code':'ibo','value':'Igbo'}, {'code':'ipk','value':'Inupiaq'}, {'code':'ido','value':'Ido'}, {'code':'isl','value':'Icelandic'},
{'code':'ita','value':'Italian'}, {'code':'iku','value':'Inuktitut'}, {'code':'jpn','value':'Japanese'}, {'code':'jav','value':'Javanese'}, {'code':'kal','value':'Kalaallisut, Greenlandic'},
{'code':'kan','value':'Kannada'}, {'code':'kau','value':'Kanuri'}, {'code':'kas','value':'Kashmiri'}, {'code':'kaz','value':'Kazakh'}, {'code':'khm','value':'Khmer'},
{'code':'kik','value':'Kikuyu, Gikuyu'}, {'code':'kin','value':'Kinyarwanda'}, {'code':'kir','value':'Kyrgyz'}, {'code':'kom','value':'Komi'}, {'code':'kon','value':'Kongo'},
{'code':'kor','value':'Korean'}, {'code':'kur','value':'Kurdish'}, {'code':'kua','value':'Kwanyama, Kuanyama'}, {'code':'lat','value':'Latin'}, {'code':'ltz','value':'Luxembourgish, Letzeburgesch'},
{'code':'lug','value':'Ganda'}, {'code':'lim','value':'Limburgish, Limburgan, Limburger'}, {'code':'lin','value':'Lingala'}, {'code':'lao','value':'Lao'}, {'code':'lit','value':'Lithuanian'},
{'code':'lub','value':'Luba-Katanga'}, {'code':'lav','value':'Latvian'}, {'code':'glv','value':'Manx'}, {'code':'mkd','value':'Macedonian'}, {'code':'mlg','value':'Malagasy'},
{'code':'msa','value':'Malay'}, {'code':'mal','value':'Malayalam'}, {'code':'mlt','value':'Maltese'}, {'code':'mri','value':'Māori'}, {'code':'mar','value':'Marathi (Marāṭhī)'},
{'code':'mah','value':'Marshallese'}, {'code':'mon','value':'Mongolian'}, {'code':'nau','value':'Nauruan'}, {'code':'nav','value':'Navajo, Navaho'}, {'code':'nde','value':'Northern Ndebele'},
{'code':'nep','value':'Nepali'}, {'code':'ndo','value':'Ndonga'}, {'code':'nob','value':'Norwegian Bokmål'}, {'code':'nno','value':'Norwegian Nynorsk'}, {'code':'nor','value':'Norwegian'},
{'code':'iii','value':'Nuosu'}, {'code':'nbl','value':'Southern Ndebele'}, {'code':'oci','value':'Occitan'}, {'code':'oji','value':'Ojibwe, Ojibwa'}, {'code':'chu','value':'Old Church Slavonic, Church Slavonic, Old Bulgarian'},
{'code':'orm','value':'Oromo'}, {'code':'ori','value':'Oriya'}, {'code':'oss','value':'Ossetian, Ossetic'}, {'code':'pan','value':'Panjabi, Punjabi'}, {'code':'pli','value':'Pāli'},
{'code':'fas','value':'Persian (Farsi)'}, {'code':'pol','value':'Polish'}, {'code':'pus','value':'Pashto, Pushto'}, {'code':'por','value':'Portuguese'}, {'code':'que','value':'Quechua'},
{'code':'roh','value':'Romansh'}, {'code':'run','value':'Kirundi'}, {'code':'rcf','value':'Reunionese, Reunion Creole'}, {'code':'ron','value':'Romanian'}, {'code':'rus','value':'Russian'},
{'code':'san','value':'Sanskrit (Saṁskṛta)'}, {'code':'srd','value':'Sardinian'}, {'code':'snd','value':'Sindhi'}, {'code':'sme','value':'Northern Sami'}, {'code':'smo','value':'Samoan'},
{'code':'sag','value':'Sango'}, {'code':'srp','value':'Serbian'}, {'code':'gla','value':'Scottish Gaelic, Gaelic'}, {'code':'sna','value':'Shona'}, {'code':'sin','value':'Sinhalese, Sinhala'},
{'code':'slk','value':'Slovak'}, {'code':'slv','value':'Slovene'}, {'code':'som','value':'Somali'}, {'code':'sot','value':'Southern Sotho'}, {'code':'spa','value':'Spanish'},
{'code':'sun','value':'Sundanese'}, {'code':'swa','value':'Swahili'}, {'code':'ssw','value':'Swati'}, {'code':'swe','value':'Swedish'}, {'code':'tam','value':'Tamil'},
{'code':'tel','value':'Telugu'}, {'code':'tgk','value':'Tajik'}, {'code':'tha','value':'Thai'}, {'code':'tir','value':'Tigrinya'}, {'code':'bod','value':'Tibetan Standard, Tibetan, Central'},
{'code':'tuk','value':'Turkmen'}, {'code':'tgl','value':'Tagalog'}, {'code':'tsn','value':'Tswana'}, {'code':'ton','value':'Tonga (Tonga Islands)'}, {'code':'tur','value':'Turkish'},
{'code':'tso','value':'Tsonga'}, {'code':'tat','value':'Tatar'}, {'code':'twi','value':'Twi'}, {'code':'tah','value':'Tahitian'}, {'code':'uig','value':'Uyghur'},
{'code':'ukr','value':'Ukrainian'}, {'code':'urd','value':'Urdu'}, {'code':'uzb','value':'Uzbek'}, {'code':'ven','value':'Venda'}, {'code':'vie','value':'Vietnamese'},
{'code':'vol','value':'Volapük'}, {'code':'wln','value':'Walloon'}, {'code':'cym','value':'Welsh'}, {'code':'wol','value':'Wolof'}, {'code':'fry','value':'Western Frisian'},
{'code':'xho','value':'Xhosa'}, {'code':'yid','value':'Yiddish'}, {'code':'yor','value':'Yoruba'}, {'code':'zha','value':'Zhuang, Chuang'}, {'code':'zul','value':'Zulu'}];
var menuData =  [
  {
    text: 'Main Information',
    icon: 'glyphicon glyphicon-signal'
  },
  {
    text: 'Health Status',
    icon: 'glyphicon glyphicon-scale'
  },
  {
    text: 'CCDA Information',
    icon: 'glyphicon glyphicon-list-alt'
  }
];

var Panel=React.createClass(
{
    render: function()
    {
        var titleNodes = this.props.data.map(function(component)
        {
            return (
                <div className="col-md-4 col-sm-4 mb">
                    <div className="darkblue-panel pn">
                            <div className="darkblue-header">
                                <h5>{component.section.title}</h5>
                            </div>
                            <p className="user">{component.section.code.code}</p>
                    </div>
                </div>
            );
        });

        return(
            <div>
                {titleNodes}
            </div>
        );
    }
});


class PatientDetails extends React.Component
{
    render()
    {    
        var patientRole=this.props.patientRole;
        var patientMap = getPatientDetails(patientRole); 
        var iconGender = (patientMap.gender==="Female" || patientMap.gender==="F")?"assets/img/woman.png":"assets/img/man.jpg";
        return(
            <div>
              <div className="col-lg-2 col-md-2 col-sm-2 mb"></div>
              <div className="col-lg-8 col-md-8 col-sm-8 mb">
                  <div className="weather-2 patientDetails">
                      <div className="weather-2-header">
                          <h1 className="centered">{patientMap.name}</h1>
                      </div>
                      <div className="row data">
                        <p>
                          <img src={iconGender} className="img-circle" width="80" />
                          <b>{patientMap.firstName}</b> is a {patientMap.age} year old <b>{patientMap.race}</b>&nbsp;
                          <b>{patientMap.maritalStatus}</b>  <b>{patientMap.gender}</b>, which speaks <b>{patientMap.language}</b>. 
                        </p>                      
                        <dl>
                            <li><dt>Day of Birth: </dt><dd>{patientMap.dob}</dd></li>
                            <li><dt>Address: </dt><dd>{patientMap.address}</dd></li>   
                            <li><dt>Religion: </dt><dd>{patientMap.religion}</dd></li>   
                            <li><dt>Phone: </dt><dd>{patientMap.contact}</dd></li>
                            <li><dt>Guardian: </dt><dd>{patientMap.guardianName}</dd></li>                   
                        </dl>
                      </div>
                  </div>
              </div>
            </div>
        );
    }
}

class Allergies extends React.Component
{
    render()
    {
        if(!this.props.data)
            return;

        var elements=[];
        var rows=this.props.data.rows;
        var headers=this.props.data.headers;

        for(var r=0; r<rows.length; r++)
        {
            if(!elements[r])
                elements[r]=[];

            for(var i=0; i<headers.length; i++)
                elements[r].push(
                    // <div className="list-group-item">
                    //     <p className="list-group-item-text">
                    <p>
                            <span className="label label-primary">{headers[i]}</span>
                            {rows[r][i]}
                    </p>
                    //     </p>
                    // </div>
                );
        }

        var listItems=(elements.map(function(element)
        {
            return(
                <div className="list-group-item">
                    <div className="list-group-item-text">
                        {element}
                    </div>
                </div>
            );
        }));

        return(
            <div className="col-lg-4 col-md-4 col-sm-4 mb">
                <div className="white-panel pn">
                    <div className="white-header">
                        <h4>{this.props.title}</h4>
                    </div>
                    <div className="list-group">
                        {listItems}
                    </div>
                </div>
            </div>
        );
    }
}

class XMLForm extends React.Component
{
    render()
    {
        return(
            <div className="modal-content" >
                <div className="modal-header">
                    <button type="button" className="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 className="modal-title" id="myModalLabel">Load new patient data</h4>
                </div>
                <div className="modal-body">
                    <form id="upload-form" action="http://localhost:8088/cda" method="post" enctype="multipart/form-data" onSubmit={this.handleSubmit}>
                        <div className="form-group">
                            <label>Choose file</label>
                            <input type="file" name="file"/>
                        </div>
                    </form>
                </div>
                <div className="modal-footer">
                    <button type="button" className="btn btn-danger" data-dismiss="modal">Cancel</button>
                    <input type="submit" form="upload-form" className="btn btn-primary" value="Upload"/>
                </div>
            </div>
        );
    }

    handleSubmit(event)
    {
        event.preventDefault();
        // this.setState({ type: 'info', message: 'Sending...' }, this.sendFormData);

        $.ajax(
        {
            url: $(event.target).prop("action"),
            type: "POST",
            data: new FormData(event.target),
            success: function(data)
            {
                debugvar=data;
                var components = data.ClinicalDocument.component.structuredBody.component;
                var title = data.ClinicalDocument.title;
                var patientRole=data.ClinicalDocument.recordTarget.patientRole;
                var medicationsTitle = "";
                var medicationsArr = new Array();

                for(let i=0; i<components.length; i++)
                {
                    let section=components[i].section;
                    let sectionTitle=section.title;

                    let tableData=getNodeTableData(section.text.table);
                    //console.log("displaying section: "+sectionTitle);

                    switch(section.code.code)
                    {
                        // Allergies
                        case "48765-2":
                            ReactDOM.render(<Allergies title={sectionTitle} data={tableData}/>, document.getElementById("allergies"));
                            break;
                        case "10160-0":
                            /*iterate(section.text, medicationsArr);
                            console.log(searchString("table", section.text));
                            console.log(medicationsArr);

                            for(var j = 0; j < medicationsArr.length; j++){
                                console.log(medicationsArr[j]);
                            }*/

                            //ReactDOM.render(<Allergies title={sectionTitle} data={tableData}/>, document.getElementById("medications"));
                            break;
                    }
                }

                $("#myModal").modal("toggle");

                /* Added by VV to get the sections, for build the menu. */
            
                var title = null;
                var titles=[];
                for(var i = 0; i < components.length; i++){
                    
                    title = getSectionTitle(components[i].section)
                    if (title!=null) {
                        titles.push({"text": title, "code": components[i].section.code.code});
                    }   
                }
                
                var originalData = [];
                originalData.push({text: 'Main Information',icon: 'glyphicon glyphicon-signal'});
                originalData.push({text: 'Health Status',icon: 'glyphicon glyphicon-scale'});
                originalData.push({text: 'CCDA Info',icon: 'glyphicon glyphicon-list-alt', nodes: titles});

                ReactDOM.render(<Panel data={components}/>, document.getElementById("panels"));
                ReactDOM.render(<PatientDetails patientRole={patientRole}/>, document.getElementById("patientDetails"));
                ReactDOM.render(<TreeView treeData={originalData}/>, document.getElementById("tree_menu"));
            },
            error: function(err)
            {
                console.log("error: "+err);
            },
            processData: false,
            contentType: false
        });
    }
}

/* Classes created by VV to create handle the menu. */
var TreeView = React.createClass(
  {
  displayName: "TreeView",
  propTypes: {
    levels: React.PropTypes.number,
    treeData: React.PropTypes.array,
    expandIcon: React.PropTypes.string,
    collapseIcon: React.PropTypes.string,
    emptyIcon: React.PropTypes.string,
    nodeIcon: React.PropTypes.string,

    color: React.PropTypes.string,
    backColor: React.PropTypes.string,
    borderColor: React.PropTypes.string,
    onhoverColor: React.PropTypes.string,
    selectedColor: React.PropTypes.string,
    selectedBackColor: React.PropTypes.string,

    enableLinks: React.PropTypes.bool,
    highlightSelected: React.PropTypes.bool,
    showBorder: React.PropTypes.bool,
    showTags: React.PropTypes.bool,

    nodes: React.PropTypes.array
  },

  getDefaultProps: function () {
    return {
      levels: 2,
      treeData: undefined,
      expandIcon: 'glyphicon glyphicon-plus',
      collapseIcon: 'glyphicon glyphicon-minus',
      emptyIcon: 'glyphicon',
      nodeIcon: 'glyphicon glyphicon-asterisk',

      color: '#0A3F6C',
      backColor: undefined,
      borderColor: undefined,
      onhoverColor: '#F5F5F5', // TODO Not implemented yet, investigate radium.js 'A toolchain for React component styling'
      selectedColor: '#FFFFFF',
      selectedBackColor: '#428bca',

      enableLinks: false,
      highlightSelected: true,
      showBorder: true,
      showTags: false,

      nodes: []
    }
  },

  setNodeId: function(node) {

    if (!node.nodes) return;

    var _this = this;
    node.nodes.forEach(function checkStates(node) {
      node.nodeId = _this.props.nodes.length;
      _this.props.nodes.push(node);
      _this.setNodeId(node);
    });
  },

  render: function() {
    this.treeData = this.props.treeData;
    this.setNodeId({ nodes: this.treeData });

    var children = [];
    if (this.treeData) {
      var _this = this;
      this.treeData.forEach(function (node) {
        children.push(React.createElement(TreeNode, {node: node, 
                                level: 1, 
                                visible: true, 
                                options: _this.props}));
      });
    }

    return (
      <div id="treeview" clasName="treeview">
        <ul className="list-group">
          { children }
        </ul>
      </div>
    )
  }
});

var TreeNode = React.createClass({
  displayName: "TreeNode",
  getInitialState: function() {
    var node = this.props.node;

    return {
      expanded: (node.state && node.state.hasOwnProperty('expanded')) ?
                  node.state.expanded :
                    (this.props.level < this.props.options.levels) ?
                      true :
                      false,
      selected: (node.state && node.state.hasOwnProperty('selected')) ? 
                  node.state.selected :
                  false
    }
  },

  toggleExpanded: function(id, event) {
    this.setState({ expanded: !this.state.expanded });
    event.stopPropagation();
  },

  toggleSelected: function(id, event) {
    this.setState({ selected: !this.state.selected });
    event.stopPropagation();
  },

  render: function() {

    var node = this.props.node;
    var options = this.props.options;

    var style;
    if (!this.props.visible) {

      style = { 
        display: 'none' 
      };
    }
    else {

      if (options.highlightSelected && this.state.selected) {
        style = {
          color: options.selectedColor,
          backgroundColor: options.selectedBackColor
        };
      }
      else {
        style = {
          color: node.color || options.color,
          backgroundColor: node.backColor || options.backColor
        };
      }

      if (!options.showBorder) {
        style.border = 'none';
      }
      else if (options.borderColor) {
        style.border = '1px solid ' + options.borderColor;
      }
    } 

    var indents = [];
    for (var i = 0; i < this.props.level-1; i++) {
      indents.push(React.createElement("span", {className: "indent"}));
    }

    var expandCollapseIcon;
    if (node.nodes) {
      if (!this.state.expanded) {
        expandCollapseIcon = (
          React.createElement("span", {className: options.expandIcon, 
                onClick: this.toggleExpanded.bind(this, node.nodeId)}
          )
        );
      }
      else {
        expandCollapseIcon = (
          React.createElement("span", {className: options.collapseIcon, 
                onClick: this.toggleExpanded.bind(this, node.nodeId)}
          )
        );
      }
    }
    else {
      expandCollapseIcon = (
        React.createElement("span", {className: options.emptyIcon})
      );
    }

    var nodeIcon = (
      React.createElement("span", {className: "icon"}, 
        React.createElement("i", {className: node.icon || options.nodeIcon})
      )
    );

    var nodeText;
    if (options.enableLinks) {
      nodeText = (
        React.createElement("a", {href: node.href/*style="color:inherit;"*/}, 
          node.text
        )
      );
    }
    else {
      nodeText = (
        React.createElement("span", {className: "text"}, node.text)
      );
    }

    var badges;
    if (options.showTags && node.tags) {
      badges = node.tags.map(function (tag) {
        return (
          React.createElement("span", {className: "badge"}, tag)
        );
      });
    }

    var children = [];
    if (node.nodes) {
      var _this = this;
      node.nodes.forEach(function (node) {
        children.push(React.createElement(TreeNode, {node: node, 
                                level: _this.props.level+1, 
                                visible: _this.state.expanded && _this.props.visible, 
                                options: options}));
      });
    }

    return (
      React.createElement("li", {className: "list-group-item", 
          style: style, 
          onClick: this.toggleSelected.bind(this, node.nodeId), 
          key: node.nodeId}, 
        indents, 
        expandCollapseIcon, 
        nodeIcon, 
        nodeText, 
        badges, 
        children
      )
    );
  }
});

/*** Utility functions ***/

/* Extract just the text inside a node when there might be additional attributes 
(in that case the text content is inside "$")
*/

function getNodeText(nodeElement)
{
    if(!nodeElement)
        return null;
    if(typeof nodeElement==="string" || nodeElement instanceof String)
        return nodeElement;
    if(typeof nodeElement==="number" || nodeElement instanceof Number)
      return nodeElement;
    return nodeElement.$
}

/* Extract just the title of a "Section" node. */
function getSectionTitle(nodeElement)
{
    if(!nodeElement)
        return null;
    if (nodeElement.title !== null)
        return nodeElement.title;
}

/*Obtain all text from an unformated node*/
function iterate(obj, jsonArr) {
    for(var key in obj) {
        var elem = obj[key];

        if(typeof elem === "object") {
            iterate(elem, jsonArr); // call recursively
        }
        else{
            var patt = /ID|border|width|height|styleCode|cellpadding|cellspacing/;

            if(!patt.test(key.toString())){
                jsonArr.push({"key":key.toString(),"text":elem});
            }
        }
    }
}

/*VV, Get the gender out of the genderCode */
function getGender(patientObj) {
  var gender;
  if (patientObj.administrativeGenderCode) {
    if (searchString("displayName", patientObj.administrativeGenderCode)) {
      gender = patientObj.administrativeGenderCode.displayName;
    } else if (patientObj.administrativeGenderCode.code) {
      gender = patientObj.administrativeGenderCode.code=="F"?"Female":"Male";
    } else gender = "UNKNOWN";
  }
  return gender;
}

/*VV, Get the Race out of the RaceCode */
function getRace(patientObj) {
  var race;
  if (patientObj.raceCode && patientObj.raceCode.length==1) {
    if (searchString("displayName", patientObj.raceCode)) {
      race = patientObj.raceCode.displayName;
    } else race = "Unkown race";
  } else if (patientObj.raceCode && patientObj.raceCode.length>1) {
    race = "Unkown race";
    if (searchString("displayName", patientObj.raceCode[0])) {
        race = patientObj.raceCode[0].displayName;
    }
    for (var i=1; i<patientObj.raceCode.length;i++) {
      if (searchString("displayName", patientObj.raceCode[i])) {
        race += " [" + patientObj.raceCode[i].displayName + "]";
      }
    }
  }
  return race;
}

/*VV, Get the Religion out of the religiousAffiliationCode */
function getReligion(patientObj) {
  var religion;
  if (patientObj.religiousAffiliationCode) {
    if (searchString("displayName", patientObj.religiousAffiliationCode)) {
      religion = patientObj.religiousAffiliationCode.displayName;
    } else religion = "";
  }
  return religion;
}

/*VV, Get the MaritalStatus out of the maritalStatusCode */
function getMaritalStatus(patientObj) {
  var mStatus;
  if (patientObj.maritalStatusCode) {
    if (searchString("displayName", patientObj.maritalStatusCode)) {
      mStatus = patientObj.maritalStatusCode.displayName;
    } else if (patientObj.maritalStatusCode.code) {
      mStatus = patientObj.maritalStatusCode.code;
    } else mStatus = "";
  }
  return mStatus;
}

/*VV, Get the Language out of the languageCommunication */
function getLanguage(patientObj) {
  var language, languageCode;
  if (patientObj.languageCommunication && patientObj.languageCommunication.languageCode) {
    languageCode = patientObj.languageCommunication.languageCode.code;
  } else return "?";
  
  language = languageCode.length==2?languages639_1.filter(function(obj) { return obj.code.toLowerCase() === languageCode.toLowerCase() }):languages639_2.filter(function(obj) { return obj.code.toLowerCase() === languageCode.toLowerCase() });

  return language.length>0?language[0].value:"?";
}


function getPatientDetails(patientRole) {
  //console.log("getPatientDetails: " + JSON.stringify(patientRole));
  var patientName=patientRole.patient.name;
  var name=buildName(patientName);
  var dob=moment(patientRole.patient.birthTime.value).format("LL");
  var guardian=patientRole.patient.guardian;
  var address=buildAddress(patientRole.addr);
  var contact=buildTelecom(patientRole.telecom);
  var guardianName;
  var gender = getGender(patientRole.patient);
  var religion = getReligion(patientRole.patient);
  var race = getRace(patientRole.patient);
  var mStatus = getMaritalStatus(patientRole.patient);
  var age = Math.floor(moment(new Date()).diff(patientRole.patient.birthTime.value,'years',true));
  var language = getLanguage(patientRole.patient);
  if(guardian) {
      var guardianEntity=guardian.guardianPerson ? guardian.guardianPerson : guardian.guardianOrganization;
      guardianName=buildName(guardianEntity.name);
  }
  var patientMap = {
    "firstName":patientRole.patient.name.given,
    "name":name,
    "dob":dob,
    "guardian":guardian!=undefined?guardian:"---",
    "address":address,
    "contact":contact!=undefined?contact:"UNKNOWN",
    "gender":gender,
    "race":race,
    "religion":religion,
    "maritalStatus":mStatus,
    "guardianName":guardianName!=undefined?guardianName:"---",
    "language":language,
    "age":age};
  return patientMap;
}


function searchString(str, obj) {
    for(var key in obj) {
        if(key.toString() === str)
            return true;

        var elem = obj[key];

        if(typeof elem === "object") {
            searchString(elem); // call recursively
        }
    }

    return false;
}

function getNodeTableData(tableNode)
{
    if(!tableNode)
        return null;

    var tableData={headers:[], rows:[]}

    if(tableNode.thead)
        for(var i=0; i<tableNode.thead.tr.th.length; i++)
            tableData.headers.push(getNodeText(tableNode.thead.tr.th[i]));
    else
        tableData.headers[0]=[];

    if(!Array.isArray(tableNode.tbody.tr))
       tableNode.tbody.tr=[tableNode.tbody.tr];

    for(var r=0; r<tableNode.tbody.tr.length; r++)
    {

        if(tableNode.tbody.tr[r].td)
            for(var c=0; c<tableNode.tbody.tr[r].td.length; c++)
            {
                if(!tableData.rows[r])
                    tableData.rows[r]=[];

                tableData.rows[r].push(getNodeText(tableNode.tbody.tr[r].td[c]));
            }
    }

    debug2=tableData;
    return tableData;
}

function buildName(nameNode)
{
    if(!nameNode)
        return null;

    var name="";

    // use the first occurrence of name if more than one is found
    if(Array.isArray(nameNode))
        nameNode=nameNode[0];

    if(nameNode.prefix)
        name=getNodeText(nameNode.prefix)+" ";

    if(Array.isArray(nameNode.given))
    {
        for(var i=0; i<nameNode.given.length; i++)
            name+=getNodeText(nameNode.given[i])+" ";
    }
    else
        name+=getNodeText(nameNode.given)+" ";

    name+=getNodeText(nameNode.family);

    if(nameNode.suffix)
        name+=", "+getNodeText(nameNode.suffix);

    return name;
}

function buildAddress(addressNode)
{
    if(!addressNode)
        return null;

    var street, city, state, zip;

    // if more than one address, use the first one
    if(Array.isArray(addressNode))
        addressNode=addressNode[0];

    street=getNodeText(addressNode.streetAddressLine);
    city=getNodeText(addressNode.city);
    state=getNodeText(addressNode.state);
    zip=getNodeText(addressNode.postalCode);
    var address = street + ", " + city + ", " + state + ". " + zip;
    console.log(address);
    return address;
}

/* Contact information */
function buildTelecom(telecomNode)
{
    if(!telecomNode)
        return null;

    if(Array.isArray(telecomNode))
    {
        var contact=[];

        for(var i=0; i<telecomNode.length; i++)
        {
            var value=telecomNode[i].value;
            contact.push(
                {value}
            );
        }
        console.log(JSON.stringify(contact));
        return contact;
    }

    return telecomNode.value;
}

ReactDOM.render(<XMLForm/>, document.getElementById("modal-container"));
ReactDOM.render(<TreeView treeData={menuData}/>, document.getElementById("tree_menu"));
